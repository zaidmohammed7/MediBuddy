<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>MediBuddy - Prescriptions</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <header class="top-nav">
      <div class="top-nav-left">
        <div class="brand">MediBuddy</div>
        <nav class="top-links">
          <a href="{{ url_for('index') }}" class="nav-link {% if active_page == 'dashboard' %}active{% endif %}">Dashboard</a>
          <a href="{{ url_for('prescriptions') }}" class="nav-link {% if active_page == 'prescriptions' %}active{% endif %}">Prescriptions</a>
          <a href="{{ url_for('reminders') }}" class="nav-link {% if active_page == 'reminders' %}active{% endif %}">Reminders</a>
          <a href="{{ url_for('chatbot') }}" class="nav-link {% if active_page == 'chatbot' %}active{% endif %}">Chatbot</a>
          <a href="{{ url_for('settings') }}" class="nav-link {% if active_page == 'settings' %}active{% endif %}">Settings</a>
        </nav>
      </div>
    </header>

    <main class="prescriptions-shell">
      <!-- LEFT: LIST + UPDATE/DELETE -->
      <section class="card prescriptions-list">
        <h1 class="card-title">My Prescriptions</h1>
        <input class="prescriptions-search" placeholder="Search by name / dosage / prescriber" />

        {% if prescriptions %}
          {% for p in prescriptions %}
          <div class="prescription-item">
            <div class="prescription-name">
              {{ p.drug_name }} — {{ p.frequency }}
            </div>
            <div class="prescription-meta">
              Qty: {{ p.qty_on_hand }} • Refills: {{ p.refills }}
              {% if p.rx_text %}
                • Notes: {{ p.rx_text }}
              {% endif %}
            </div>

            <!-- UPDATE form -->
            <form action="{{ url_for('update_prescription', rx_id=p.rx_id) }}"
                  method="POST"
                  class="prescription-edit-form">
              <div class="form-row">
                <div class="form-field">
                  <label class="form-label">Frequency</label>
                  <input class="form-input" name="frequency" value="{{ p.frequency }}" required />
                </div>
                <div class="form-field">
                  <label class="form-label">Quantity on hand</label>
                  <input type="number" class="form-input" name="qty_on_hand"
                         value="{{ p.qty_on_hand }}" min="0" required />
                </div>
                <div class="form-field">
                  <label class="form-label">Refills</label>
                  <input type="number" class="form-input" name="refills"
                         value="{{ p.refills }}" min="0" required />
                </div>
              </div>

              <div class="form-field">
                <label class="form-label">Instructions / notes</label>
                <input class="form-input" name="rx_text" value="{{ p.rx_text or '' }}" />
              </div>

              <div class="form-actions">
                <button class="btn-primary" type="submit">Save changes</button>
              </div>
            </form>

            <!-- DELETE form -->
            <form action="{{ url_for('delete_prescription', rx_id=p.rx_id) }}"
                  method="POST"
                  class="prescription-delete-form">
              <button class="btn-secondary" type="submit">Delete</button>
            </form>
          </div>
          {% endfor %}
        {% else %}
          <p>No prescriptions yet. Add one on the right.</p>
        {% endif %}
      </section>

      <!-- RIGHT: CREATE -->
      <section class="card prescriptions-detail">
        <h1 class="card-title">Add Prescription</h1>
      
        <form action="{{ url_for('create_prescription') }}" method="POST">
          <div class="form-field">
            <label class="form-label">Drug</label>
            <select class="form-input" name="drug_id" required>
              {% for d in drugs %}
                <option value="{{ d.drug_id }}">{{ d.name }}</option>
              {% endfor %}
            </select>
          </div>
      
          <div class="form-field">
            <label class="form-label">Frequency</label>
            <input class="form-input" name="frequency" placeholder="once_daily / bid / q8h" required />
          </div>
      
          <div class="form-row">
            <div class="form-field">
              <label class="form-label">Quantity on hand</label>
              <input type="number" class="form-input" name="qty_on_hand" value="0" min="0" required />
            </div>
            <div class="form-field">
              <label class="form-label">Refills</label>
              <input type="number" class="form-input" name="refills" value="0" min="0" required />
            </div>
          </div>
      
          <div class="form-field">
            <label class="form-label">Instructions / notes</label>
            <input class="form-input" name="rx_text" placeholder="Take with food, etc." />
          </div>
      
          <div class="form-actions">
            <button class="btn-primary" type="submit">Save</button>
          </div>
        </form>
        <hr />

        <h2 class="card-title">Manage Drugs</h2>

        <!-- Add new drug -->
        <form action="{{ url_for('create_drug') }}" method="POST">
          <div class="form-row">
            <div class="form-field">
              <label class="form-label">Drug name</label>
              <input class="form-input" name="drug_name" placeholder="e.g. Metformin 500mg" required />
            </div>
            <div class="form-field">
              <label class="form-label">RxNorm code (optional)</label>
              <input class="form-input" name="rxnorm_code" placeholder="e.g. 860975" />
            </div>
          </div>
          <div class="form-actions">
            <button class="btn-primary" type="submit">Add drug</button>
          </div>
        </form>

        <!-- Existing drugs list with delete -->
        <div class="interaction-panel">
          <p><strong>Existing drugs:</strong></p>
          {% for d in drugs %}
            <div class="prescription-meta">
              {{ d.name }}
              {% if d.rxnorm_code %} (RxNorm: {{ d.rxnorm_code }}){% endif %}
              <form action="{{ url_for('delete_drug', drug_id=d.drug_id) }}"
                    method="POST"
                    style="display:inline;">
                <button class="btn-secondary" type="submit">Delete</button>
              </form>
            </div>
          {% endfor %}
        </div>
      </section>
    </main>
  </body>
</html>
